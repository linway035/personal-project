<head>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
  />
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
    integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
    crossorigin="anonymous"
  ></script>
  <link rel="stylesheet" href="/stylesheets/style.css" />
</head>

<main class="content">
  <div class="container p-0">
    <h1 class="h3 mb-3">Messages</h1>

    <div class="card">
      <div class="row g-0">
        <div class="col-12 col-lg-5 col-xl-3 border-right">
          <div class="px-4 d-none d-md-block">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <input
                  type="text"
                  class="form-control my-3"
                  placeholder="Search..."
                />
              </div>
            </div>
          </div>

          <!-- 抓取http://localhost:3000/chats/rooms -->
          <a href="#" class="list-group-item list-group-item-action border-0">
            <div class="badge bg-success float-right">5</div>
            <div class="d-flex align-items-start">
              <img
                src="https://bootdey.com/img/Content/avatar/avatar5.png"
                class="rounded-circle mr-1"
                alt="Vanessa Tucker"
                width="40"
                height="40"
              />
              <div class="flex-grow-1 ml-3">
                Vanessa Tucker
                <div class="small">
                  <span class="fas fa-circle chat-online"></span> Online
                </div>
              </div>
            </div>
          </a>

          <hr class="d-block d-lg-none mt-1 mb-0" />
        </div>
        <div class="col-12 col-lg-7 col-xl-9">
          <div class="py-2 px-4 border-bottom d-none d-lg-block">
            <div class="d-flex align-items-center py-1">
              <div class="position-relative">
                <img
                  src="https://bootdey.com/img/Content/avatar/avatar3.png"
                  class="rounded-circle mr-1"
                  alt="Sharon Lessman"
                  width="40"
                  height="40"
                />
              </div>
              <div class="flex-grow-1 pl-3">
                <strong>Sharon Lessman</strong>
                <div class="text-muted small"><em>Typing...</em></div>
              </div>
            </div>
          </div>

          <div class="position-relative">
            <div class="chat-messages p-4">
              <div class="chat-message-right pb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar1.png"
                    class="rounded-circle mr-1"
                    alt="Chris Wood"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:33 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                  <div class="font-weight-bold mb-1">You</div>
                  Lorem ipsum dolor sit amet, vis erat denique in, dicunt
                  prodesset te vix.
                </div>
              </div>

              <div class="chat-message-left pb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar3.png"
                    class="rounded-circle mr-1"
                    alt="Sharon Lessman"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:34 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                  <div class="font-weight-bold mb-1">Sharon Lessman</div>
                  Sit meis deleniti eu, pri vidit meliore docendi ut, an eum
                  erat animal commodo.
                </div>
              </div>

              <div class="chat-message-right mb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar1.png"
                    class="rounded-circle mr-1"
                    alt="Chris Wood"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:35 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                  <div class="font-weight-bold mb-1">You</div>
                  Cum ea graeci tractatos.
                </div>
              </div>

              <div class="chat-message-left pb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar3.png"
                    class="rounded-circle mr-1"
                    alt="Sharon Lessman"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:36 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                  <div class="font-weight-bold mb-1">Sharon Lessman</div>
                  Sed pulvinar, massa vitae interdum pulvinar, risus lectus
                  porttitor magna, vitae commodo lectus mauris et velit. Proin
                  ultricies placerat imperdiet. Morbi varius quam ac venenatis
                  tempus.
                </div>
              </div>

              <div class="chat-message-left pb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar3.png"
                    class="rounded-circle mr-1"
                    alt="Sharon Lessman"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:37 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                  <div class="font-weight-bold mb-1">Sharon Lessman</div>
                  Cras pulvinar, sapien id vehicula aliquet, diam velit
                  elementum orci.
                </div>
              </div>

              <div class="chat-message-right mb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar1.png"
                    class="rounded-circle mr-1"
                    alt="Chris Wood"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:38 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                  <div class="font-weight-bold mb-1">You</div>
                  Lorem ipsum dolor sit amet, vis erat denique in, dicunt
                  prodesset te vix.
                </div>
              </div>

              <div class="chat-message-left pb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar3.png"
                    class="rounded-circle mr-1"
                    alt="Sharon Lessman"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:39 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                  <div class="font-weight-bold mb-1">Sharon Lessman</div>
                  Sit meis deleniti eu, pri vidit meliore docendi ut, an eum
                  erat animal commodo.
                </div>
              </div>

              <div class="chat-message-right mb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar1.png"
                    class="rounded-circle mr-1"
                    alt="Chris Wood"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:40 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                  <div class="font-weight-bold mb-1">You</div>
                  Cum ea graeci tractatos.
                </div>
              </div>

              <div class="chat-message-right mb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar1.png"
                    class="rounded-circle mr-1"
                    alt="Chris Wood"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:41 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                  <div class="font-weight-bold mb-1">You</div>
                  Morbi finibus, lorem id placerat ullamcorper, nunc enim
                  ultrices massa, id dignissim metus urna eget purus.
                </div>
              </div>

              <div class="chat-message-left pb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar3.png"
                    class="rounded-circle mr-1"
                    alt="Sharon Lessman"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:42 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                  <div class="font-weight-bold mb-1">Sharon Lessman</div>
                  Sed pulvinar, massa vitae interdum pulvinar, risus lectus
                  porttitor magna, vitae commodo lectus mauris et velit. Proin
                  ultricies placerat imperdiet. Morbi varius quam ac venenatis
                  tempus.
                </div>
              </div>

              <div class="chat-message-right mb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar1.png"
                    class="rounded-circle mr-1"
                    alt="Chris Wood"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:43 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                  <div class="font-weight-bold mb-1">You</div>
                  Lorem ipsum dolor sit amet, vis erat denique in, dicunt
                  prodesset te vix.
                </div>
              </div>

              <div class="chat-message-left pb-4">
                <div>
                  <img
                    src="https://bootdey.com/img/Content/avatar/avatar3.png"
                    class="rounded-circle mr-1"
                    alt="Sharon Lessman"
                    width="40"
                    height="40"
                  />
                  <div class="text-muted small text-nowrap mt-2">2:44 am</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                  <div class="font-weight-bold mb-1">Sharon Lessman</div>
                  Sit meis deleniti eu, pri vidit meliore docendi ut, an eum
                  erat animal commodo.
                </div>
              </div>
            </div>
          </div>

          <div class="flex-grow-0 py-3 px-4 border-top">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                placeholder="Type your message"
              />
              <button class="btn btn-primary">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<style>
  body {
    margin-top: 20px;
  }

  .chat-online {
    color: #34ce57;
  }

  .chat-offline {
    color: #e4606d;
  }

  .chat-messages {
    display: flex;
    flex-direction: column;
    max-height: 800px;
    overflow-y: scroll;
  }

  .chat-message-left,
  .chat-message-right {
    display: flex;
    flex-shrink: 0;
  }

  .chat-message-left {
    margin-right: auto;
  }

  .chat-message-right {
    flex-direction: row-reverse;
    margin-left: auto;
  }
  .py-3 {
    padding-top: 1rem !important;
    padding-bottom: 1rem !important;
  }
  .px-4 {
    padding-right: 1.5rem !important;
    padding-left: 1.5rem !important;
  }
  .flex-grow-0 {
    flex-grow: 0 !important;
  }
  .border-top {
    border-top: 1px solid #dee2e6 !important;
  }
</style>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  let socket = io()
  const form = document.getElementById('form')
  const input = document.getElementById('input')
  const messages = document.getElementById('messages')
  const chatHeader = document.getElementById('chatHeader')
  const senderId = localStorage.getItem('userId')
  const userName = localStorage.getItem('name')
  const leftPanel = document.querySelector('.left-panel')
  console.log('sender', senderId, 'userName', userName) //sender 17 userName WaForTest
  let activeChatRoom = null

  // 左側列表
  fetch('./chats/rooms')
    .then(response => response.json())
    .then(data => {
      data.forEach(user => {
        const chatUserElement = document.createElement('div')
        chatUserElement.classList.add('chat-user')
        chatUserElement.setAttribute(
          'onclick',
          `openChat('${user.receiver_name}', ${user.room_id})`
        )
        chatUserElement.setAttribute('data-chat-user', user.receiver_name)

        const descriptionElement = document.createElement('div')
        descriptionElement.classList.add('description')

        const chatNameElement = document.createElement('div')
        chatNameElement.classList.add('chat-name')
        chatNameElement.textContent = user.receiver_name

        descriptionElement.appendChild(chatNameElement)
        chatUserElement.appendChild(descriptionElement)
        leftPanel.appendChild(chatUserElement)
      })
    })
    .catch(error => {
      console.log('Error fetching chat user list:', error)
    })

  function openChat(chatUser, roomId) {
    socket.emit('join', { roomId: roomId.toString(), userName })
    chatHeader.textContent = chatUser
    messages.innerHTML = ''
    activeChatRoom = roomId
    fetch(`./chats/messages/${roomId}`)
      .then(response => response.json())
      .then(data => {
        data.forEach(chat => {
          const li = document.createElement('li')
          li.classList.add('message')
          li.textContent = chat.message
          messages.appendChild(li)
        })
      })
      .catch(error => {
        console.log(`Error fetching chat messages for ${chatUser}:`, error)
      })
  }
  socket.on('message', ({ sender, room, message }) => {
    const li = document.createElement('li')
    li.classList.add('message')
    li.textContent = message
    messages.appendChild(li)
  })

  form.addEventListener('submit', function (e) {
    e.preventDefault()
    const message = input.value.trim()
    if (message !== '') {
      const li = document.createElement('li')
      li.classList.add('message')
      li.textContent = message
      messages.appendChild(li)
      // 發送訊息到伺服器
      console.log(activeChatRoom)
      socket.emit('message', {
        sender: senderId,
        room: activeChatRoom,
        message: message,
      })
      input.value = ''
    }
  })
</script>
